---
title: 20190519 编程反思
date: 2019-05-19 22:43:03
tags: [技术反思]
---

## 1 Linux Shell 命令

shell 编程不能被打断，确认提示、输入密码提示这些都是要我们想办法避免的。

### 1.1 CentOS yum 安装软件时，用 -y 可以避免安装软件时的确认提示

### 1.2 mv -f 可以直接覆盖同名的文件，避免覆盖的确认提示

### 1.3 sleep 可以加后缀，比如 sleep 1m 休眠 1 分钟

### 1.4 使用反引号进行命令替换，比如

```shell
pid=`ps aux | grep chrome | grep -v grep | awk '{print $2}'`
```

### 1.5 tar 打包可以指定 -C 解决打包全路径的问题

```shell
# 不使用 -C，打包后的将保留全路径
tar -czvf adsl-abot.tar.gz ~/git/ms/abot-adsl
# 使用 -C，打包后只保留路径 abot-adsl
tar -czvf adsl-abot.tar.gz -C ~/git/ms abot-adsl
```

### 1.6 ssh -a 可以 ssh 登录后自动执行设定命令

```shell
ssh server1 -a 'python run.py > /dev/null &'
```

### 1.7 ssh 可通过 ssh key 免密码登录，以便 shell 编程访问服务器

```shell
# 生成 ssh key，注意不要设定 passphrase，直接回车即可
ssh-keygen -t rsa -b 4096 -C "user@example.com"
# 拷贝公钥到服务器
ssh-copy-id  -i ~/.ssh/id_rsa  -p <port> <name>@<host>
# 配置 ~/.ssh/config
Host server1
User <name>
HostName <host>
Port <port>
IdentityFile ./id_rsa
# shell 访问
ssh server1
```

### 1.8 curl -x 可以指定使用代理访问，-o 可以保存为文件

```shell
# 代理访问
curl -x 120.83.121.55:8881 https://readhub.cn/topics
# 下载文件
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
```

## 2 DocumentDB 读取负载均衡问题

DocumentDB 设置了读取终端节点，发现大量的读取操作还是落在了写入终端节点。翻阅文档，发现：

> 仅当 Amazon DocumentDB以副本集模式从集群终端节点读取数据时，才支持设置读取首选项。
>
> ...
>
> 如果您的客户端或驱动程序未在副本集模式下连接到 Amazon DocumentDB集群终端节点，则指定读取首选项的结果并不明确。
>
> — [Amazon DocumentDB 开发人员指南](https://docs.aws.amazon.com/zh_cn/documentdb/latest/developerguide/how-it-works.html#durability-consistency-isolation.read-consistency)

可见，实现读取负载均衡的必要条件是：

1. **设置了副本集模式**

   DocumentDB 默认有名为 rs0 的副本集，通过 `mongodb://username:password@sample-cluster.cluster-123456789012.us-east-1.docdb.amazonaws.com:27017/?replicaSet=rs0` 连接字符串设置。

2. **设置了合适的读取首选项**

   一般设置 secondaryPreferred 让读请求优先路由到只读副本。Java 代码示例：

   ```java
     MongoClientSettings settings = MongoClientSettings.builder().applyConnectionString(connectionString).codecRegistry(pojoCodecRegistry).readPreference(ReadPreference.secondaryPreferred()).build();
   ```

官方文档中说明的可配置的读取首选项有：

1. **primary**：确保将所有读取请求路由到集群的主实例。
2. **primaryPreferred**：将读取请求路由到主实例。如果发生主实例故障转移，则客户端会将请求路由到副本。
3. **secondary**：确保只将读取路由到副本，从不路由到主实例。
4. **secondaryPreferred**：确保在一个或多个副本处于活动状态时将读取路由到只读副本。如果集群中没有活动的副本实例，则读取请求将路由到主实例。
5. **nearest**：仅基于客户端与 Amazon DocumentDB集群中所有实例之间测量的延迟路由读取。

## 3 Git Submodule

### 3.1 git submodule detached HEAD

很好奇为什么拉取拉取代码并执行

```shell
$ git submodule init # 在 zsh 中为 gsi
$ git submodule update # 在 zsh 中为 gsu
```

后到子模块文件夹查看 git 状态，然后就是 `detached HEAD status` 了。

![git detached HEAD](20190519 编程反思/git detached HEAD.png)

查阅 git 官方文档，发现

> So far, when we’ve run the `git submodule update` command to fetch changes from the submodule repositories, Git would get the changes and update the files in the subdirectory but will leave the sub-repository in what’s called a “detached HEAD” state. 
>
> —  [git - Submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules) 

意味着这不是你的错，它本来就是这样的，你需要做的是：

```shell
$ cd <子模块文件夹>
$ git checkout <你要的分支> # 在 zsh 中为 gco 
```

这样，你在子模块的修改就不会丢了，可以正常提交到子模块项目指定分支中。

### 3.2 在主项目查看子模块的改变

在查阅官方文档过程中发现一个好用的命令，可以在主项目查看子模块的改变，如下：

```shell
$ git config status.submodulesummary 1

$ git status # 在 zsh 中为 gst
On branch master
Your branch is up-to-date with 'origin/master'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory)

	modified:   .gitmodules
	modified:   DbConnector (new commits)

Submodules changed but not updated:

* DbConnector c3f01dc...c87d55d (4):
  > catch non-null terminated lines
```

### 3.3 foreach 骚操作

在官方文档中，我还发现 git 支持对所有 submodule 执行同一命令的骚操作，看下面的代码

```shell
# 将所有子模块的改变 stash
$ git submodule foreach 'git stash'
# 将所有子模块切换到 master 分支
$ git submodule foreach 'git checkout -b master'
```

## 4 Jenkins 打包流程

1. 拉取 master 分支及其子模块的代码
2. 然后切换到指定的分支
3. 开始打包
4. 包存储到指定的 s3 存储桶

要注意上面的每一步都正确，最后才是佛光普照。在我的 case，master 分支上的 submodule 存在commit id 找不到的问题，虽然我在 release 分支已经解决，仍需要先将相关的改变同步到 master，因为在未将该改变回到 master 之前，第一步会失败。

## 5 ssh 私钥登录 Linux 服务器仍提示输入密码的问题

ssh 私钥登录 Linux 服务器的关键有 4：

1. 生成私钥时**不设定 passphrase**；
2. `.ssh` 文件夹权限为 **700**，只对 root 用户可读可写可执行；
3. 本地私钥文件的权限为 **600**，只对 root 用户可读可写；
4. 服务器上 `.ssh/authorized_keys` 文件权限为 **600**，只对 root 用户可读可写。

第 1 项需要我们自己保证，剩下的 3 项在使用 `ssh-copy-id` 时已经可以保证，如果检查了上述  4 项都没问题，但还是提示输入密码，那就很可能是服务器的问题了。在我的经历中，遇到过 2 项：

1. 服务器开启了 SELinux，这时只需要关闭即可

   ```shell
   # 编辑 selinux 配置
   vi /etc/sysconfig/selinux
   # 修改配置项目
   SELINUX=disabled
   # 保存退出，可能需要重启服务器
   ```

2. 服务器 `/root` 的所属用户和所属组不是 root，这时改一下所属用户和所属组即可

   ```shell
   # 改所属用户为 root
   chown root /root
   # 改所属组为 root
   chgrp root /root
   ```

